<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIPYME en tu casa - Sistema de Entregas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --color-principal: #fcbf49;
      --color-acento: #d62828;
      --color-fondo: #fffdf9;
      --color-texto: #333;
      --sombra: 0 4px 12px rgba(0,0,0,0.1);
      --borde-radius: 15px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--color-fondo);
      color: var(--color-texto);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 200vh;
    }
    
    h1, h2, h3 {
      color: var(--color-acento);
      font-weight: 700;
    }
    
    .contenedor {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .hero {
      background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
                 url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center center/cover no-repeat;
      height: 90vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      color: white;
      position: relative;
    }
    
    .hero h1 {
      font-size: 3.5rem;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
      margin-bottom: 20px;
      max-width: 800px;
    }
    
    .hero p {
      font-size: 1.5rem;
      margin-bottom: 30px;
      max-width: 700px;
    }
    
    .btn {
      display: inline-block;
      background: var(--color-principal);
      color: #000;
      padding: 15px 35px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: var(--sombra);
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      background: #ffc107;
    }
    
    .btn-acento {
      background: var(--color-acento);
      color: white;
    }
    
    .btn-acento:hover {
      background: #e63946;
    }
    
    section {
      padding: 80px 0;
    }
    
    .titulo-seccion {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 50px;
      position: relative;
    }
    
    .titulo-seccion::after {
      content: '';
      display: block;
      width: 100px;
      height: 4px;
      background: var(--color-principal);
      margin: 15px auto;
      border-radius: 2px;
    }
    
    .menu-categorias {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 40px;
    }
    
    .categoria-btn {
      background: white;
      padding: 10px 25px;
      border-radius: 30px;
      color: var(--color-acento);
      font-weight: bold;
      text-decoration: none;
      border: 2px solid #f0f0f0;
      transition: all 0.3s;
    }
    
    .categoria-btn:hover, .categoria-btn.active {
      background: var(--color-principal);
      border-color: var(--color-principal);
      color: black;
    }
    
    .categoria-grid {
      display: grid;
      gap: 30px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .producto {
      background: white;
      border-radius: var(--borde-radius);
      padding: 20px;
      box-shadow: var(--sombra);
      text-align: center;
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .producto:hover {
      transform: translateY(-10px);
    }
    
    .producto img {
      height: 180px;
      width: 100%;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .producto h3 {
      margin-bottom: 10px;
      font-size: 1.3rem;
      flex-grow: 1;
    }
    
    .producto .precio {
      font-weight: bold;
      font-size: 1.4rem;
      margin: 10px 0;
      color: #222;
    }
    
    .contador {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .contador input {
      width: 70px;
      padding: 8px;
      text-align: center;
      border: 2px solid #eee;
      border-radius: 6px;
      font-weight: bold;
    }
    
    #map {
      height: 400px;
      border-radius: var(--borde-radius);
      margin-bottom: 25px;
      box-shadow: var(--sombra);
      z-index: 1;
    }
    
    .info-entrega {
      background: white;
      border-radius: var(--borde-radius);
      padding: 25px;
      box-shadow: var(--sombra);
      margin-top: 30px;
    }
    
    .info-entrega p {
      margin-bottom: 15px;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
    }
    
    .info-entrega span {
      font-weight: bold;
      color: var(--color-acento);
    }
    
    .ruta-mensaje {
      padding: 10px;
      background: #e3f2fd;
      border-radius: 6px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s;
    }
    
    .ruta-error {
      background: #ffebee;
    }
    
    #resumen-pedido {
      background: white;
      border-radius: var(--borde-radius);
      padding: 30px;
      box-shadow: var(--sombra);
    }
    
    #detalle-resumen {
      margin-bottom: 25px;
    }
    
    #resumen-lista {
      list-style: none;
      margin-bottom: 25px;
    }
    
    #resumen-lista li {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
    }
    
    .eliminar-item {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .eliminar-item:hover {
      background: #ff5252;
      transform: scale(1.1);
    }
    
    .resumen-totales {
      font-size: 1.2rem;
      padding: 15px 0;
      border-top: 2px solid #eee;
      border-bottom: 2px solid #eee;
      margin: 20px 0;
    }
    
    .resumen-totales p {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    #btn-arriba {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: var(--color-principal);
      color: black;
      font-weight: bold;
      font-size: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 60px;
      text-decoration: none;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: visible;
      pointer-events: auto;
    }
    
    #btn-arriba:hover {
      transform: scale(1.1);
      background: #ffc107;
    }
    
    #btn-arriba::after {
      content: "‚ñ≤";
    }
    
    footer {
      background: #333;
      color: white;
      padding: 40px 0;
      text-align: center;
      margin-top: 50px;
    }
    
    .cargando {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--color-acento);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-container {
      text-align: center;
      padding: 40px 20px;
      background: #ffebee;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .error-title {
      color: #d62828;
      margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 2.5rem;
      }
      .hero p {
        font-size: 1.2rem;
      }
      section {
        padding: 60px 0;
      }
      .titulo-seccion {
        font-size: 2rem;
      }
      .categoria-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      .producto img {
        height: 160px;
      }
      #map {
        height: 300px;
      }
      #btn-arriba {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 20px;
        line-height: 50px;
      }
    }
    
    @media (max-width: 480px) {
      .hero h1 {
        font-size: 2rem;
      }
      .btn {
        padding: 12px 25px;
        font-size: 1rem;
      }
      .titulo-seccion {
        font-size: 1.8rem;
      }
      .categoria-btn {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
      .producto {
        padding: 15px;
      }
      #btn-arriba {
        bottom: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
        font-size: 18px;
        line-height: 45px;
      }
    }
  </style>
</head>
<body>
  <!-- Cabecera Hero -->
  <header class="hero">
    <div class="contenedor">
      <h1>MIPYME en tu casa</h1>
      <p>Sistema de entregas con c√°lculo preciso de rutas</p>
      <a href="#menu" class="btn btn-acento">Ver productos disponibles</a>
    </div>
  </header>

  <!-- Secci√≥n de Productos -->
  <section id="menu">
    <div class="contenedor">
      <h2 class="titulo-seccion">Productos disponibles</h2>
      
      <nav class="menu-categorias">
        <a href="#categoria-Alimentos" class="categoria-btn active">üçΩÔ∏è Alimentos</a>
        <a href="#categoria-Aseo" class="categoria-btn">üß¥ Aseo</a>
        <a href="#categoria-Bebidas" class="categoria-btn">ü•§ Bebidas</a>
        <a href="#categoria-Otros" class="categoria-btn">üì¶ Otros</a>
      </nav>
      
      <div id="contenedor-productos">
        <div class="cargando">
          <div class="spinner"></div>
          <p>Cargando productos...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Secci√≥n de Entrega -->
  <section id="delivery">
    <div class="contenedor">
      <h2 class="titulo-seccion">üöö Servicio a domicilio</h2>
      
      <div id="map"></div>
      
      <div class="info-entrega">
        <p>üìç Haz clic en el mapa para marcar tu ubicaci√≥n. <span id="geo-msg" style="font-style:italic; color:#666;">Detectando ubicaci√≥n...</span></p>
        <div id="ruta-mensaje" class="ruta-mensaje" style="display: none;">
          <span>üì°</span>
          <span>Calculando ruta por carretera...</span>
        </div>
        <p><strong>Distancia por carretera:</strong> <span id="distancia">0</span> km</p>
        <p><strong>Entrega:</strong> <span id="precio">0</span> CUP</p>
        <p><strong>Total con env√≠o:</strong> <span id="total-con-envio">0</span> CUP</p>
      </div>
    </div>
  </section>

  <!-- Resumen del Pedido -->
  <section id="resumen-pedido" style="display: none;">
    <div class="contenedor">
      <h2 class="titulo-seccion">üßæ Resumen del pedido</h2>
      
      <div id="detalle-resumen">
        <ul id="resumen-lista"></ul>
        
        <div class="resumen-totales">
          <p><strong>Productos:</strong> <span id="resumen-total-productos">0</span> CUP</p>
          <p><strong>Delivery:</strong> <span id="resumen-delivery">0</span> CUP</p>
          <p><strong>Total con env√≠o:</strong> <span id="resumen-total-final">0</span> CUP</p>
        </div>

        <button id="confirmar-resumen" class="btn btn-acento">
          Confirmar pedido por WhatsApp
        </button>
      </div>
    </div>
  </section>

  <!-- Pie de p√°gina -->
  <footer>
    <div class="contenedor">
      <p>¬© 2025 MIPYME en tu casa - Todos los derechos reservados</p>
      <p style="margin-top: 15px;">Desarrollado con ‚ù§Ô∏è para emprendedores locales</p>
    </div>
  </footer>

  <!-- Bot√≥n flotante -->
  <button id="btn-arriba" title="Ir al men√∫"></button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Configuraci√≥n de la aplicaci√≥n
    const config = {
      puntoVenta: { lat: 22.401355, lng: -79.970718 },
      precioPorKm: 200,
      maxIntentos: 3,
      maxDistancia: 50,
      openRouteApiKey: "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImUyYzA5MWQ2NDliMjQxMDZiMTgzMmMxNDZmNjM4YzM3IiwiaCI6Im11cm11cjY0In0=",
      routeCache: {},
      apiTimeout: 5000
    };
    
    // Variables globales
    let carrito = [];
    let destinoCliente = null;
    let distanciaCarreteraKm = 0;
    let precioDelivery = 0;
    let calculandoRuta = false;
    let map, marker, routeLayer;
    
    // Elementos del DOM
    const geoMsg = document.getElementById('geo-msg');
    const rutaMensaje = document.getElementById('ruta-mensaje');
    
    // Cargar carrito desde localStorage
    function loadCart() {
      const saved = localStorage.getItem('mipyme_cart');
      if (saved) {
        try {
          carrito = JSON.parse(saved) || [];
          actualizarResumenPedido();
        } catch (e) {
          console.error('Error cargando carrito:', e);
          carrito = [];
        }
      }
    }
    
    // Guardar carrito en localStorage
    function saveCart() {
      localStorage.setItem('mipyme_cart', JSON.stringify(carrito));
    }
    
    // Inicializar la aplicaci√≥n
    function initApp() {
      initMap();
      cargarProductosCSV();
      loadCart();
      setupEventListeners();
    }
    
    // Inicializar el mapa
    function initMap() {
      map = L.map('map').setView([config.puntoVenta.lat, config.puntoVenta.lng], 15);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      
      // Marcador para el punto de venta
      L.marker(config.puntoVenta, {
        icon: L.divIcon({
          className: 'punto-venta-icon',
          html: '<div style="background: #d62828; width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; border: 2px solid white;">üè¨</div>',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        })
      }).addTo(map).bindPopup('Nuestro punto de venta');
      
      // Intentar geolocalizaci√≥n al cargar
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const userPos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            map.setView(userPos, 15);
            if (marker) map.removeLayer(marker);
            marker = L.marker(userPos).addTo(map);
            destinoCliente = userPos;
            calcularRutaCarretera(config.puntoVenta, destinoCliente);
            geoMsg.textContent = 'Ubicaci√≥n detectada autom√°ticamente.';
          },
          error => {
            console.error('Error en geolocalizaci√≥n:', error);
            geoMsg.textContent = 'No se pudo obtener tu ubicaci√≥n. Haz clic en el mapa.';
          }
        );
      } else {
        geoMsg.textContent = 'Tu navegador no soporta geolocalizaci√≥n. Haz clic en el mapa.';
      }
    }
    
    // Configurar event listeners
    function setupEventListeners() {
      // Evento de clic en el mapa
      map.on('click', async e => {
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        destinoCliente = e.latlng;
        geoMsg.textContent = 'Ubicaci√≥n seleccionada manualmente.';
        await calcularRutaCarretera(config.puntoVenta, destinoCliente);
        actualizarResumenPedido();
      });
      
      // Bot√≥n flotante
      document.getElementById('btn-arriba').addEventListener('click', () => {
        document.getElementById('menu').scrollIntoView({ behavior: 'smooth' });
      });
      
      // Scroll para mostrar/ocultar bot√≥n flotante
      window.addEventListener("scroll", () => {
        const y = window.scrollY;
        const btnArriba = document.getElementById("btn-arriba");
        btnArriba.style.display = y > 500 ? "flex" : "none";
      });
      
      // Confirmar pedido por WhatsApp
      document.getElementById("confirmar-resumen").addEventListener("click", confirmarPedido);
      
      // Navegaci√≥n de categor√≠as
      document.querySelectorAll('.categoria-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.categoria-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });
    }
    
    // Calcular ruta por carretera
    async function calcularRutaCarretera(origen, destino) {
      if (!destino) {
        mostrarMensajeRuta('‚ö†Ô∏è Selecciona una ubicaci√≥n en el mapa', true);
        return;
      }
      
      if (calculandoRuta) return;
      calculandoRuta = true;
      mostrarMensajeRuta('üîÑ Calculando la mejor ruta...');
      
      const cacheKey = `${origen.lat.toFixed(6)},${origen.lng.toFixed(6)}-${destino.lat.toFixed(6)},${destino.lng.toFixed(6)}`;
      
      if (config.routeCache[cacheKey]) {
        distanciaCarreteraKm = config.routeCache[cacheKey];
        actualizarCostosEnvio();
        dibujarRutaEnMapa(null);
        mostrarMensajeRuta(`‚úÖ Ruta calculada: ${distanciaCarreteraKm} km (desde cach√©)`);
        calculandoRuta = false;
        return;
      }
      
      let intentos = 0;
      let exito = false;
      
      while (intentos < config.maxIntentos && !exito) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), config.apiTimeout);
          
          const response = await fetch(
            `https://api.openrouteservice.org/v2/directions/driving-car`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': config.openRouteApiKey
              },
              body: JSON.stringify({
                coordinates: [
                  [origen.lng, origen.lat],
                  [destino.lng, destino.lat]
                ],
                options: {
                  avoid_features: ["ferries"]
                }
              }),
              signal: controller.signal
            }
          );
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Verificaci√≥n robusta de la respuesta
          if (!data.routes || !Array.isArray(data.routes) || data.routes.length === 0 ||
              !data.routes[0].summary || !data.routes[0].summary.distance ||
              !data.routes[0].geometry || !Array.isArray(data.routes[0].geometry.coordinates)) {
            throw new Error("La API devolvi√≥ una respuesta inv√°lida");
          }
          
          const distanciaMetros = data.routes[0].summary.distance;
          distanciaCarreteraKm = (distanciaMetros / 1000).toFixed(2);
          config.routeCache[cacheKey] = distanciaCarreteraKm;
          
          dibujarRutaEnMapa(data);
          actualizarCostosEnvio();
          exito = true;
          
          mostrarMensajeRuta(`‚úÖ Ruta calculada: ${distanciaCarreteraKm} km`);
        } catch (error) {
          intentos++;
          console.error(`Intento ${intentos} fallido:`, error);
          
          if (intentos < config.maxIntentos) {
            mostrarMensajeRuta(`‚ö†Ô∏è Reintentando (${intentos}/${config.maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000));
          } else {
            mostrarMensajeRuta(`‚ùå Error: ${error.message || 'Servicio no disponible'}`, true);
            usarDistanciaAproximada(origen, destino);
          }
        }
      }
      
      calculandoRuta = false;
    }
    
    // Mostrar mensaje de ruta
    function mostrarMensajeRuta(mensaje, esError = false) {
      rutaMensaje.style.display = 'flex';
      rutaMensaje.innerHTML = `<span>${mensaje.split(' ')[0]}</span><span>${mensaje.substring(2)}</span>`;
      rutaMensaje.className = esError ? 'ruta-mensaje ruta-error' : 'ruta-mensaje';
    }
    
    // Dibujar ruta en el mapa
    function dibujarRutaEnMapa(routeData) {
      if (routeLayer) map.removeLayer(routeLayer);
      
      if (routeData) {
        try {
          const coordinates = routeData.routes[0].geometry.coordinates;
          const latLngs = coordinates.map(coord => L.latLng(coord[1], coord[0]));
          
          routeLayer = L.polyline(latLngs, {
            color: '#d62828',
            weight: 4,
            opacity: 0.7,
            smoothFactor: 1
          }).addTo(map);
          
          map.fitBounds(routeLayer.getBounds());
        } catch (error) {
          console.error('Error dibujando ruta:', error);
          mostrarMensajeRuta('‚ö†Ô∏è Error dibujando ruta', true);
          usarDistanciaAproximada(config.puntoVenta, destinoCliente);
        }
      }
      
      if (!marker && destinoCliente) {
        marker = L.marker(destinoCliente).addTo(map);
      }
    }
    
    // Actualizar costos de env√≠o
    function actualizarCostosEnvio() {
      precioDelivery = Math.round(distanciaCarreteraKm * config.precioPorKm);
      const totalProductos = carrito.reduce((t, i) => t + i.precio * i.cantidad, 0);
      const total = totalProductos + precioDelivery;
      
      document.getElementById('distancia').textContent = distanciaCarreteraKm;
      document.getElementById('precio').textContent = precioDelivery;
      document.getElementById('total-con-envio').textContent = total;
      
      if (document.getElementById('resumen-delivery')) {
        document.getElementById('resumen-delivery').textContent = precioDelivery;
        document.getElementById('resumen-total-final').textContent = total;
      }
      
      if (distanciaCarreteraKm > config.maxDistancia) {
        mostrarMensajeRuta('‚ö†Ô∏è Distancia supera el l√≠mite permitido', true);
      }
    }
    
    // Funci√≥n de fallback para distancia aproximada
    function usarDistanciaAproximada(coord1, coord2) {
      const R = 6371;
      const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
      const dLon = (coord2.lng - coord1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(coord1.lat * Math.PI/180) * 
                Math.cos(coord2.lat * Math.PI/180) * Math.sin(dLon/2)**2;
      
      distanciaCarreteraKm = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(2);
      actualizarCostosEnvio();
      
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.polyline([coord1, coord2], {
        color: '#9e9e9e',
        weight: 2,
        dashArray: '5, 10',
        opacity: 0.7
      }).addTo(map);
    }
    
    // Cargar productos desde CSV
    async function cargarProductosCSV() {
      try {
        // Simulaci√≥n de carga de productos (en producci√≥n, cargar√≠a desde un CSV real)
        const productos = [
          { nombre: "Arroz Integral", precio: 25.50, categoria: "Alimentos", imagen: "arroz.jpg" },
          { nombre: "Jab√≥n de Ba√±o", precio: 15.00, categoria: "Aseo", imagen: "jabon.jpg" },
          { nombre: "Agua Mineral", precio: 20.00, categoria: "Bebidas", imagen: "agua.jpg" },
          { nombre: "Caf√© Molido", precio: 35.75, categoria: "Alimentos", imagen: "cafe.jpg" },
          { nombre: "Detergente L√≠quido", precio: 28.90, categoria: "Aseo", imagen: "detergente.jpg" },
          { nombre: "Refresco de Cola", precio: 18.50, categoria: "Bebidas", imagen: "refresco.jpg" },
          { nombre: "Aceite de Oliva", precio: 42.30, categoria: "Alimentos", imagen: "aceite.jpg" },
          { nombre: "Papel Higi√©nico", precio: 12.75, categoria: "Aseo", imagen: "papel.jpg" }
        ];
        
        mostrarProductosDesdeCSV(productos);
      } catch (err) {
        console.error('Error cargando productos:', err);
        mostrarErrorProductos('Error cargando los productos');
      }
    }
    
    // Mostrar productos en la p√°gina
    function mostrarProductosDesdeCSV(productos) {
      const contenedor = document.getElementById('contenedor-productos');
      contenedor.innerHTML = '';
      
      const categorias = {};
      
      // Agrupar productos por categor√≠a
      productos.forEach((prod, index) => {
        const categoria = prod.categoria || "Otros";
        if (!categorias[categoria]) {
          categorias[categoria] = [];
        }
        categorias[categoria].push(prod);
      });
      
      // Mostrar cada categor√≠a
      Object.keys(categorias).forEach(categoria => {
        const productosCategoria = categorias[categoria];
        
        const categoriaHTML = `
          <h3 id="categoria-${categoria}" style="margin: 40px 0 20px; color: var(--color-acento);">
            ${categoria === 'Alimentos' ? 'üçΩÔ∏è' : categoria === 'Aseo' ? 'üß¥' : categoria === 'Bebidas' ? 'ü•§' : 'üì¶'} 
            ${categoria}
          </h3>
          <div class="categoria-grid" id="grid-${categoria}"></div>
        `;
        
        contenedor.innerHTML += categoriaHTML;
        
        const grid = document.getElementById(`grid-${categoria}`);
        productosCategoria.forEach((prod, idx) => {
          const idInput = `qty-${categoria}-${idx}`;
          const div = document.createElement("div");
          div.className = "producto";
          div.innerHTML = `
            <img src="https://source.unsplash.com/random/300x200/?${encodeURIComponent(prod.nombre)}" alt="${prod.nombre}">
            <h3>${prod.nombre}</h3>
            <p class="precio">${prod.precio} CUP</p>
            <div class="contador">
              <input type="number" id="${idInput}" value="1" min="1">
              <button onclick="addToCart('${prod.nombre}', ${prod.precio}, '${idInput}')" class="btn" style="padding: 8px 15px;">
                Agregar
              </button>
            </div>
          `;
          grid.appendChild(div);
        });
      });
    }
    
    // Mostrar error de productos
    function mostrarErrorProductos(mensaje) {
      const contenedor = document.getElementById('contenedor-productos');
      contenedor.innerHTML = `
        <div class="error-container">
          <h3 class="error-title">Error cargando productos</h3>
          <p>${mensaje}</p>
          <p>Por favor intenta recargar la p√°gina</p>
        </div>
      `;
    }
    
    // A√±adir producto al carrito
    function addToCart(nombre, precio, inputId) {
      const cantidad = parseInt(document.getElementById(inputId).value) || 1;
      const existente = carrito.find(p => p.nombre === nombre);
      
      if (existente) {
        existente.cantidad += cantidad;
      } else {
        carrito.push({ nombre, precio, cantidad });
      }
      
      saveCart();
      actualizarResumenPedido();
      
      const btn = document.getElementById(inputId).nextElementSibling;
      btn.textContent = '‚úì Agregado';
      btn.style.background = '#25d366';
      setTimeout(() => {
        btn.textContent = 'Agregar';
        btn.style.background = '';
      }, 1500);
    }
    
    // Eliminar un producto del carrito
    function removeFromCart(index) {
      carrito.splice(index, 1);
      saveCart();
      actualizarResumenPedido();
    }
    
    // Actualizar el resumen del pedido
    function actualizarResumenPedido() {
      const lista = document.getElementById("resumen-lista");
      const totalProductos = carrito.reduce((sum, i) => sum + i.precio * i.cantidad, 0);
      lista.innerHTML = "";
      
      if (carrito.length === 0) {
        lista.innerHTML = '<li style="justify-content: center; padding: 30px 0; color: #777;">Tu carrito est√° vac√≠o</li>';
        document.getElementById('resumen-pedido').style.display = 'none';
      } else {
        carrito.forEach((item, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span>${item.nombre} x${item.cantidad} ‚Äì ${(item.precio * item.cantidad).toFixed(2)} CUP</span>
            <button class="eliminar-item" onclick="removeFromCart(${index})">‚úï</button>
          `;
          lista.appendChild(li);
        });
        document.getElementById('resumen-pedido').style.display = 'block';
      }
      
      const totalFinal = totalProductos + precioDelivery;
      
      document.getElementById("resumen-total-productos").textContent = totalProductos.toFixed(2);
      document.getElementById("resumen-delivery").textContent = precioDelivery.toFixed(2);
      document.getElementById("resumen-total-final").textContent = totalFinal.toFixed(2);
    }
    
    // Confirmar pedido
    function confirmarPedido() {
      if (!destinoCliente) {
        alert("Por favor, selecciona tu ubicaci√≥n en el mapa antes de confirmar el pedido üìç");
        return;
      }
      
      if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o üõí");
        return;
      }
      
      const totalProductos = carrito.reduce((t, i) => t + i.precio * i.cantidad, 0);
      const km = document.getElementById('distancia').textContent;
      const precioDelivery = document.getElementById('precio').textContent;
      const total = document.getElementById('total-con-envio').textContent;
      
      let mensaje = `¬°Hola! Quisiera confirmar este pedido:%0A%0A`;
      mensaje += `*Detalle del pedido:*%0A`;
      carrito.forEach(p => {
        mensaje += `- ${p.nombre} x${p.cantidad} (${(p.precio * p.cantidad).toFixed(2)} CUP)%0A`;
      });
      mensaje += `%0A*Resumen:*%0A`;
      mensaje += `Productos: ${totalProductos.toFixed(2)} CUP%0A`;
      mensaje += `Delivery (${km} km): ${precioDelivery} CUP%0A`;
      mensaje += `*TOTAL: ${total} CUP*%0A%0A`;
      mensaje += `üìç *Ubicaci√≥n de entrega:*%0A`;
      mensaje += `https://www.google.com/maps?q=${destinoCliente.lat},${destinoCliente.lng}%0A%0A`;
      mensaje += `¬°Gracias!`;
      
      const telefono = "5354776437";
      const enlace = `https://wa.me/${telefono}?text=${mensaje}`;
      window.open(enlace, '_blank');
    }
    
    // Iniciar la aplicaci√≥n cuando el DOM est√© cargado
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>