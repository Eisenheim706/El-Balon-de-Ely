<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Pedido - A TU PUERTA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(to right, #fcbf49, #d62828);
      color: white;
      padding: 20px 0;
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    
    #map {
      height: 400px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .info-panel {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .status-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .status-step {
      text-align: center;
      flex: 1;
      position: relative;
    }
    
    .status-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      right: 0;
      width: 100%;
      height: 3px;
      background: #eee;
      z-index: 1;
    }
    
    .status-icon {
      width: 40px;
      height: 40px;
      background: #eee;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      position: relative;
      z-index: 2;
    }
    
    .status-active .status-icon {
      background: #4caf50;
      color: white;
    }
    
    .status-active .status-title {
      color: #4caf50;
      font-weight: bold;
    }
    
    .product-list {
      list-style: none;
      margin-top: 15px;
    }
    
    .product-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #d62828;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #ffebee;
      color: #d32f2f;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      margin: 20px 0;
    }
    
    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      color: #777;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>A TU PUERTA</h1>
      <p>Seguimiento en tiempo real de tu pedido</p>
    </div>
  </header>
  
  <div class="container">
    <div id="map"></div>
    
    <div class="info-panel">
      <div class="status-container">
        <div class="status-step status-active" id="step-proceso">
          <div class="status-icon">1</div>
          <div class="status-title">En proceso</div>
        </div>
        <div class="status-step" id="step-camino">
          <div class="status-icon">2</div>
          <div class="status-title">En camino</div>
        </div>
        <div class="status-step" id="step-entregado">
          <div class="status-icon">3</div>
          <div class="status-title">Entregado</div>
        </div>
      </div>
      
      <h2>Detalles del pedido</h2>
      <div id="pedido-info">
        <p><strong>ID Pedido:</strong> <span id="pedido-id">---</span></p>
        <p><strong>Estado:</strong> <span id="estado-pedido">Cargando...</span></p>
        <p><strong>Hora estimada de entrega:</strong> <span id="hora-entrega">Calculando...</span></p>
      </div>
      
      <h3 style="margin-top: 15px;">Productos:</h3>
      <ul class="product-list" id="productos-lista"></ul>
    </div>
    
    <div class="info-panel">
      <h2>Ubicación actual del mensajero</h2>
      <div id="ubicacion-info">
        <p id="ubicacion-texto">Obteniendo ubicación...</p>
        <p id="distancia-restante">Calculando distancia...</p>
      </div>
    </div>
  </div>
  
  <footer>
    <p>© 2025 A TU PUERTA - Todos los derechos reservados</p>
  </footer>
  
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // Obtener ID del pedido de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const pedidoId = urlParams.get('id');
    
    // Configuración
    const config = {
      socketServer: "https://free-socket-server-1mr1.onrender.com",
      puntoVenta: { lat: 22.401355, lng: -79.970718 },
      velocidadPromedio: 30 // km/h
    };
    
    // Variables
    let map = null;
    let mensajeroMarker = null;
    let destinoMarker = null;
    let socket = null;
    let pedido = null;
    let ultimaUbicacion = null;
    
    // Inicializar mapa
    function initMap() {
      map = L.map('map').setView([config.puntoVenta.lat, config.puntoVenta.lng], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      
      // Marcador del punto de venta
      L.marker([config.puntoVenta.lat, config.puntoVenta.lng], {
        icon: L.icon({
          iconUrl: 'img/icono_logo.png',
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map).bindPopup('Nuestro punto de venta');
    }
    
    // Conectar al servidor de seguimiento
    function connectToSocket() {
      socket = io(config.socketServer, {
        transports: ['websocket'],
        reconnection: true,
        reconnectionAttempts: 5
      });
      
      socket.on('connect', () => {
        console.log('Conectado al servidor de seguimiento');
        // Unirse a la sala del pedido
        socket.emit('unirse_pedido', pedidoId);
      });
      
      socket.on('actualizacion_ubicacion', (data) => {
        if (data.pedidoId === pedidoId) {
          actualizarUbicacionMensajero(data.lat, data.lng);
        }
      });
      
      socket.on('actualizacion_estado', (data) => {
        if (data.pedidoId === pedidoId) {
          actualizarEstadoPedido(data.estado);
        }
      });
      
      socket.on('disconnect', () => {
        console.log('Desconectado del servidor de seguimiento');
      });
    }
    
    // Actualizar ubicación del mensajero en el mapa
    function actualizarUbicacionMensajero(lat, lng) {
      ultimaUbicacion = { lat, lng };
      
      if (!mensajeroMarker) {
        mensajeroMarker = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl: 'img/icono_mensajero.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map);
        
        // Crear marcador de destino si tenemos los datos del pedido
        if (pedido && pedido.ubicacionEntrega) {
          destinoMarker = L.marker([
            pedido.ubicacionEntrega.lat,
            pedido.ubicacionEntrega.lng
          ]).addTo(map).bindPopup('Destino de entrega');
          
          // Dibujar línea entre ubicaciones
          L.polyline([
            [lat, lng],
            [pedido.ubicacionEntrega.lat, pedido.ubicacionEntrega.lng]
          ], {
            color: '#d62828',
            dashArray: '5, 10',
            weight: 3
          }).addTo(map);
          
          // Calcular distancia
          const distancia = calcularDistancia(
            lat, lng, 
            pedido.ubicacionEntrega.lat, 
            pedido.ubicacionEntrega.lng
          );
          
          document.getElementById('distancia-restante').textContent = 
            `Distancia restante: ${distancia.toFixed(2)} km`;
            
          // Calcular tiempo estimado
          if (config.velocidadPromedio > 0) {
            const horas = distancia / config.velocidadPromedio;
            const minutos = Math.round(horas * 60);
            document.getElementById('hora-entrega').textContent = 
              `~${minutos} minutos`;
          }
        }
      } else {
        mensajeroMarker.setLatLng([lat, lng]);
      }
      
      // Centrar el mapa en la ubicación del mensajero
      map.setView([lat, lng], 15);
      
      // Actualizar texto
      document.getElementById('ubicacion-texto').textContent = 
        `Ubicación actual: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
    
    // Calcular distancia entre dos puntos (Haversine)
    function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radio de la Tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    // Actualizar estado del pedido
    function actualizarEstadoPedido(estado) {
      document.getElementById('estado-pedido').textContent = estado;
      
      // Actualizar pasos de estado
      document.getElementById('step-proceso').classList.toggle('status-active', estado === 'en proceso');
      document.getElementById('step-camino').classList.toggle('status-active', estado === 'en camino');
      document.getElementById('step-entregado').classList.toggle('status-active', estado === 'entregado');
    }
    
    // Simular obtención de datos del pedido (en producción sería de una API)
    function cargarDatosPedido() {
      // En una implementación real, esto vendría de una API
      // Para este ejemplo, simulamos datos
      setTimeout(() => {
        pedido = {
          id: pedidoId,
          productos: [
            { nombre: "Arroz (1kg)", cantidad: 2, precio: 100 },
            { nombre: "Frijoles (500g)", cantidad: 1, precio: 80 },
            { nombre: "Aceite (1L)", cantidad: 1, precio: 150 }
          ],
          estado: "en proceso",
          ubicacionEntrega: {
            lat: 22.407159,
            lng: -79.965703
          }
        };
        
        // Actualizar UI
        document.getElementById('pedido-id').textContent = pedidoId;
        actualizarEstadoPedido(pedido.estado);
        
        // Mostrar productos
        const productosLista = document.getElementById('productos-lista');
        pedido.productos.forEach(prod => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${prod.nombre} x ${prod.cantidad}</span><span>${prod.precio * prod.cantidad} CUP</span>`;
          productosLista.appendChild(li);
        });
        
        // Si tenemos ubicación anterior, actualizar
        if (ultimaUbicacion) {
          actualizarUbicacionMensajero(ultimaUbicacion.lat, ultimaUbicacion.lng);
        }
      }, 1500);
    }
    
    // Inicializar
    window.onload = function() {
      if (!pedidoId) {
        document.querySelector('.container').innerHTML = `
          <div class="error">
            <h2>Pedido no encontrado</h2>
            <p>No se encontró el ID del pedido en la URL</p>
            <a href="/">Volver a la página principal</a>
          </div>
        `;
        return;
      }
      
      initMap();
      connectToSocket();
      cargarDatosPedido();
    };
  </script>
</body>
</html>