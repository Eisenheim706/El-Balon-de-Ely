<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#fcbf49">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A TU PUERTA - Seguimiento de Pedido</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* Estilos específicos para seguimiento */
    .seguimiento-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 30px;
      margin: 30px auto;
      max-width: 1000px;
    }

    .pedido-info {
      text-align: center;
      margin-bottom: 30px;
    }

    .estado-container {
      margin-bottom: 30px;
    }

    .estado-bar {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-top: 20px;
    }

    .estado-bar::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 4px;
      background: #e0e0e0;
      z-index: 1;
    }

    .estado-paso {
      text-align: center;
      position: relative;
      z-index: 2;
      width: 25%;
    }

    .estado-paso .circulo {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      transition: all 0.3s ease;
    }

    .estado-paso.activo .circulo {
      background: var(--color-acento);
      box-shadow: 0 0 0 8px rgba(247, 127, 0, 0.2);
    }

    .estado-paso.completado .circulo {
      background: #4CAF50;
      box-shadow: 0 0 0 8px rgba(76, 175, 80, 0.2);
    }

    .estado-paso.completado .circulo::after {
      content: '✓';
    }

    .estado-paso p {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .map-container {
      height: 400px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 30px;
      position: relative;
      background: #f8f8f8;
      display: none; /* Oculto inicialmente */
    }

    #map-seguimiento {
      height: 100%;
      width: 100%;
    }

    .map-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 8px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }

    .contacto-mensajero {
      text-align: center;
      margin-top: 30px;
    }

    .contacto-botones {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn-llamar, .btn-whatsapp {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 30px;
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .btn-llamar {
      background: #4CAF50;
      color: white;
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
    }

    .btn-llamar:hover, .btn-whatsapp:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .info-ruta {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      display: none; /* Oculto inicialmente */
    }
  </style>
</head>
<body>

<header class="hero">
  <div class="contenedor">
    <img src="/img/icono_logo.png" alt="A TU PUERTA" style="height: 80px; margin-bottom: 20px;">
    <p style="font-size: 1.5rem; margin-bottom: 30px; max-width: 700px;">Seguimiento de tu pedido</p>
  </div>
</header>

<section class="contenedor">
  <div class="seguimiento-container">
    <div class="pedido-info">
      <h2>ID del Pedido: <span id="pedido-id">ORD-2023-8456</span></h2>
    </div>
    
    <div class="estado-container">
      <h3>Estado del Pedido</h3>
      <div class="estado-bar">
        <div class="estado-paso completado">
          <div class="circulo">1</div>
          <p>Recibido</p>
        </div>
        <div class="estado-paso" id="estado-preparacion">
          <div class="circulo">2</div>
          <p>En preparación</p>
        </div>
        <div class="estado-paso" id="estado-camino">
          <div class="circulo">3</div>
          <p>En camino</p>
        </div>
        <div class="estado-paso" id="estado-entregado">
          <div class="circulo">4</div>
          <p>Entregado</p>
        </div>
      </div>
    </div>
    
    <div id="map-container" class="map-container">
      <div id="map-seguimiento"></div>
      <div class="map-overlay">
        <strong>Leyenda:</strong> 
        <span style="color:#d62828">●</span> Mensajero • 
        <span style="color:#003049">●</span> Tienda • 
        <span style="color:#4CAF50">●</span> Destino
      </div>
    </div>
    
    <div id="info-ruta" class="info-ruta">
      <p><strong>Distancia restante:</strong> <span id="distancia-restante">0</span> km</p>
      <p><strong>Tiempo estimado:</strong> <span id="tiempo-restante">0</span> minutos</p>
    </div>
    
    <div id="contacto-mensajero" class="contacto-mensajero" style="display: none;">
      <h3>Contacta a tu mensajero</h3>
      <div class="contacto-botones">
        <a href="#" id="btn-llamar" class="btn-llamar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white">
            <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>
          </svg>
          Llamar
        </a>
        <a href="#" id="btn-whatsapp" class="btn-whatsapp">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-6.29-3.907c-.545 0-1-.448-1-1 0-.552.455-1 1-1 .543 0 1 .448 1 1 0 .552-.457 1-1 1m3 0c-.545 0-1-.448-1-1 0-.552.455-1 1-1 .543 0 1 .448 1 1 0 .552-.457 1-1 1m3.038-5.016c-2.547-.947-5.387-.82-7.96.345-2.446 1.108-4.264 3.209-4.986 5.79-.724 2.593-.3 5.302 1.173 7.455l-1.267 3.783 3.898-1.25c1.927 1.039 4.104 1.407 6.239.927 2.727-.485 5.039-2.198 6.32-4.692 1.287-2.499 1.372-5.406.23-7.997-1.14-2.585-3.443-4.516-6.247-5.151"/>
          </svg>
          WhatsApp
        </a>
      </div>
    </div>
  </div>
</section>

<footer>
  <div class="footer-contenido">
    <p>© 2025 A TU PUERTA - Todos los derechos reservados</p>
    <p style="margin-top: 15px;">Desarrollado con ❤️ para emprendedores locales</p>
  </div>
</footer>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  // Datos simulados del pedido (en producción se obtendrían de Firestore)
  const pedidoData = {
    id: "ORD-2023-8456",
    estado: "en_proceso", // "en_proceso", "en_camino", "entregado"
    mensajero: {
      telefono: "+5354789652"
    },
    puntoVenta: { lat: 22.401355, lng: -79.970718 },
    destino: { lat: 22.410, lng: -79.955 },
    ruta: null // Se llenará cuando el mensajero acepte el pedido
  };

  // Elementos del DOM
  const mapContainer = document.getElementById('map-container');
  const infoRuta = document.getElementById('info-ruta');
  const contactoMensajero = document.getElementById('contacto-mensajero');
  const btnLlamar = document.getElementById('btn-llamar');
  const btnWhatsapp = document.getElementById('btn-whatsapp');

  // Inicializar el mapa
  let map;
  let routeLayer;
  let mensajeroMarker;

  function initMap() {
    map = L.map('map-seguimiento').setView([pedidoData.puntoVenta.lat, pedidoData.puntoVenta.lng], 14);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    // Marcador del punto de venta (usando tu logo)
    const tiendaIcon = L.icon({
      iconUrl: '/img/icono_logo.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });
    
    L.marker([pedidoData.puntoVenta.lat, pedidoData.puntoVenta.lng], {
      icon: tiendaIcon
    }).addTo(map).bindPopup('<b>Punto de Venta</b><br>A TU PUERTA');
    
    // Marcador de destino
    const destinoIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzRjYWY1MCI+PHBhdGggZD0iTTEyIDJDNy41OSAyIDQgNS41OSA0IDEwQzQgMTQuNDIgNy41OSAyMiAxMiAyMkMxNi40MiAyMiAyMCAxNC40MiAyMCAxMEMyMCA1LjU5IDE2LjQxIDIgMTIgMlpNMTIgMTJDNTAuOSAxMiA1MC45IDEwIDUwLjkgMTBDNTAuOSA4LjkgMTEuMSA4LjkgMTEuMSAxMEMxMS4xIDEyIDEzLjEgMTIgMTIgMTJaIi8+PC9zdmc+',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });
    
    L.marker([pedidoData.destino.lat, pedidoData.destino.lng], {
      icon: destinoIcon
    }).addTo(map).bindPopup('<b>Ubicación de Entrega</b>');
    
    // Si hay ruta, dibujarla
    if (pedidoData.ruta) {
      dibujarRuta(pedidoData.ruta);
    }
  }

  function dibujarRuta(coordenadas) {
    // Eliminar ruta anterior si existe
    if (routeLayer) {
      map.removeLayer(routeLayer);
    }
    
    // Dibujar nueva ruta
    routeLayer = L.polyline(coordenadas, {
      color: '#d62828',
      weight: 4,
      opacity: 0.7
    }).addTo(map);
    
    // Ajustar vista para mostrar toda la ruta
    map.fitBounds(routeLayer.getBounds());
    
    // Calcular distancia total
    const distancia = calcularDistanciaRuta(coordenadas);
    document.getElementById('distancia-restante').textContent = distancia.toFixed(2);
    
    // Calcular tiempo estimado (5 min por km)
    const tiempoEstimado = Math.round(distancia * 5);
    document.getElementById('tiempo-restante').textContent = tiempoEstimado;
    
    // Mostrar info de ruta
    infoRuta.style.display = 'block';
  }

  function calcularDistanciaRuta(coordenadas) {
    let distancia = 0;
    for (let i = 1; i < coordenadas.length; i++) {
      const [lat1, lng1] = coordenadas[i-1];
      const [lat2, lng2] = coordenadas[i];
      distancia += calcularDistancia(lat1, lng1, lat2, lng2);
    }
    return distancia;
  }

  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radio de la Tierra en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // Distancia en km
  }

  function actualizarEstadoPedido(estado) {
    // Actualizar estado en la interfaz
    const estadoPreparacion = document.getElementById('estado-preparacion');
    const estadoCamino = document.getElementById('estado-camino');
    const estadoEntregado = document.getElementById('estado-entregado');
    
    // Resetear todos los estados
    estadoPreparacion.classList.remove('completado', 'activo');
    estadoCamino.classList.remove('completado', 'activo');
    estadoEntregado.classList.remove('completado', 'activo');
    
    // Configurar según el estado actual
    switch(estado) {
      case 'en_proceso':
        estadoPreparacion.classList.add('activo');
        break;
      case 'en_camino':
        estadoPreparacion.classList.add('completado');
        estadoCamino.classList.add('activo');
        mapContainer.style.display = 'block';
        contactoMensajero.style.display = 'block';
        break;
      case 'entregado':
        estadoPreparacion.classList.add('completado');
        estadoCamino.classList.add('completado');
        estadoEntregado.classList.add('completado', 'activo');
        break;
    }
  }

  // Simular cambios de estado (en producción sería en tiempo real desde Firestore)
  function simularCambiosEstado() {
    setTimeout(() => {
      // Cambiar a "en camino" después de 5 segundos
      pedidoData.estado = 'en_camino';
      actualizarEstadoPedido(pedidoData.estado);
      
      // Simular ruta (en producción vendría de la API)
      pedidoData.ruta = [
        [pedidoData.puntoVenta.lat, pedidoData.puntoVenta.lng],
        [22.403, -79.968],
        [22.405, -79.965],
        [22.407, -79.960],
        [22.408, -79.957],
        [pedidoData.destino.lat, pedidoData.destino.lng]
      ];
      
      dibujarRuta(pedidoData.ruta);
      
      // Añadir marcador del mensajero
      const mensajeroIcon = L.icon({
        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2Q2MjgyOCI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyQzIgMTcuNTIgNi40OCAyMiAxMiAyMkMxNy41MiAyMiAyMiAxNy41MiAyMiAxMkMyMiA2LjQ4IDE3LjUyIDIgMTIgMlpNMTIgMjBDNy41OCAyMCA0IDE2LjQyIDQgMTJDNCA3LjU4IDcuNTggNCAxMiA0QzE2LjQyIDQgMjAgNy41OCAyMCAxMkMyMCAxNi40MiAxNi40MiAyMCAxMiAyMFpNMTMgNi41OUwxNyAzTDE4LjQxIDQuNDFMMTQgOC4xN0wxMyA2LjU5Wk02LjUgMTRIMTVWMTJINi41VjE0Wk05LjUgMTdINVYxNUg5LjVWMTdaTTE0LjUgMTdIMTUuNVYxNUgxNC41VjE3Wk0xOSAxN0gyMFYxNUgxOVYxN1oiLz48L3N2Zz4=',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      });
      
      mensajeroMarker = L.marker([pedidoData.ruta[1][0], {
        icon: mensajeroIcon,
        zIndexOffset: 1000
      }).addTo(map).bindPopup('<b>Mensajero en camino</b>');
      
      // Simular movimiento del mensajero
      let paso = 1;
      const moverMensajero = setInterval(() => {
        if (paso >= pedidoData.ruta.length - 1) {
          clearInterval(moverMensajero);
          
          // Cambiar a estado "entregado" cuando llega al destino
          setTimeout(() => {
            pedidoData.estado = 'entregado';
            actualizarEstadoPedido(pedidoData.estado);
          }, 2000);
          return;
        }
        
        mensajeroMarker.setLatLng(pedidoData.ruta[paso]);
        
        // Calcular distancia restante
        const distanciaRestante = calcularDistanciaRuta(pedidoData.ruta.slice(paso));
        document.getElementById('distancia-restante').textContent = distanciaRestante.toFixed(2);
        
        // Calcular tiempo estimado (5 min por km)
        const tiempoEstimado = Math.max(5, Math.round(distanciaRestante * 5));
        document.getElementById('tiempo-restante').textContent = tiempoEstimado;
        
        paso++;
      }, 2000);
      
    }, 5000);
  }

  // Configurar botones de contacto
  function configurarContacto() {
    if (pedidoData.mensajero && pedidoData.mensajero.telefono) {
      btnLlamar.href = `tel:${pedidoData.mensajero.telefono}`;
      btnWhatsapp.href = `https://wa.me/${pedidoData.mensajero.telefono.replace('+', '')}`;
    }
  }

  // Inicializar cuando la página cargue
  window.onload = function() {
    // Mostrar ID del pedido
    document.getElementById('pedido-id').textContent = pedidoData.id;
    
    // Configurar estado inicial
    actualizarEstadoPedido(pedidoData.estado);
    
    // Iniciar mapa (pero permanecerá oculto hasta que el estado sea "en camino")
    initMap();
    
    // Configurar botones de contacto
    configurarContacto();
    
    // Simular cambios de estado (en producción esto sería con Firestore en tiempo real)
    simularCambiosEstado();
  };
</script>
</body>
</html>